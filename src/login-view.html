<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="shared-styles.html">

<dom-module id="login-view">

  <template>

    <style include="iron-flex iron-flex-alignment shared-styles">
      :host {
        display: block;
      }
      align-center {
        margin-left: auto;
        margin-right: auto;
        clear: both;
        display: block;
      }
      @media (min-width: 900px) {
        div.card {
          width: 350px;
        }
      }
    </style>

    <iron-ajax id="loginRequester"
      handle-as="json"
      on-response="_accountResponse"
      on-error="_accountError">
    </iron-ajax>

    <div class="card layout vertical">
      <h2>Login</h2>
      <template is="dom-if" if="{{warningMessage}}">
        <div class="warning-message">
          {{warningMessage}}
        </div>
      </template>
      <paper-input always-float-label label="Username" required="true" value="{{username}}"></paper-input>
      <paper-input always-float-label label="Password" required="true" value="{{password}}"></paper-input>
      <paper-checkbox checked="{{stayConnected}}">Stay connected</paper-checkbox>
      <br />
      <!--<paper-icon-button icon="send" on-tap="sendLogin"></paper-icon-button>-->
      <div class="layout horizontal">
        <paper-button raised on-tap="sendLogin">
          <iron-icon icon="send"></iron-icon>
          Login
        </paper-button>
        <paper-spinner-lite active="{{loading}}"></paper-spinner-lite>
      </div>
    </div>

  </template>

  <script>

    class LoginView extends Polymer.Element {
      static get is() { return 'login-view'; }

      static get properties() {
        return {
          authenticated: {
            type: Boolean,
            notify: true,
            value: false
          },
          page: {
            type: String,
            notify: true
          },
          pageToRedirectTo: {
            type: String,
            notify: true
          },
          username: {
            type: String,
            notify: true
          },
          password: {
            type: String,
            notify: true
          },
          creds: {
            type: Object,
            notify: true,
            value: {user: '', token: ''}
          },
          baseApiUrl: {
            type: String,
            value: 'http://localhost/v1/'
          },
          accountApiUrl: {
            type: String,
            value: 'account/token'
          },
          warningMessage: {
            type: String,
            notify: true,
            value: ''
          },
          loading: {
            type: Boolean,
            notify: true,
            value: false
          },
          stayConnected: {
            type: Boolean,
            value: false
          }
        };
      }

      sendLogin() {
        this.getToken(this.username, this.password);
      }

      getToken(username, password) {
        this.$.loginRequester.url = this.baseApiUrl + this.accountApiUrl;
        //this.$.loginRequester.body = '{"login": "' + username + 
        //  '","password": "' + password + '"}';
        this.$.loginRequester.body = {
          'login': username,
          'password': password
        };
        this.$.creds.user = this.username;
        this.$.loginRequester.contentType = 'application/json';
        this.$.loginRequester.method = 'POST';
        this.loading = true;
        this.warningMessage = '';
        this.$.loginRequester.generateRequest();
      }

      saveTokenCookie(token) {
        // Check the value of this.stayConnected to change the 
        // cookie lifetime.
        var expDays = 0;
        if (this.stayConnected) {
          expDays = 60;
        }
        this._setCookie('token', token, expDays);
      }

      readTokenCookie() {
        return this._getCookie('token');
      }

      loginWithCookie() {
        // Attempts to login with a cookie if present.
        // Will query the database for username attached
        // to this cookie.
        // TODO Set expires to the right value.
        var cook = this.readTokenCookie();
        this.authenticated = false;
        if (cook) {
          this.$.loginRequester.url = this.baseApiUrl + 
            this.accountApiUrl + '/' + cook;
          this.$.loginRequester.contentType = null;
          this.$.loginRequester.method = 'GET';
          // No headers to add with this call.
          this.loading = true;
          this.$.generateRequest();
        }
        return this.authenticated;
      }

      logout() {
        // We need to invalidate the cookie.

      }

      _setCookie(cname, cvalue, exdays) {
        var expires = '';
        if (exDays > 0) {
          var d = new Date();
          d.setTime(d.getTime() + (exdays*24*60*60*1000));
          expires = 'expires=' + d.toUTCString();
        }
        var cook = cname + '=' + cvalue + ';path=/';
        if (expires) {
          cook = cook + ';' + expires;
        }
        document.cookie = cook;
      }

      _getCookie(cname) {
        var name = cname + '=';
        var decodedCookie = decodeURIComponent(document.cookie);
        var ca = decodedCookie.split(';');
        for(var i = 0; i <ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) == ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
            }
        }
        return '';
      }

      _accountResponse(e) {
        this.loading = false;
        var token = e.detail.response.token;
        if (token) {
          // This iron-ajax can be used for POST or GET.
          this.creds.token = token;
          this.authenticated = true;
          console.log('Changing page to ' + this.pageToRedirectTo);
          this.page = this.pageToRedirectTo;
        } else {
          this._authFailure();
        }
        this.password = '';
      }

      _accountError(e) {
        this.loading = false;
        console.log('HTTP error from iron-ajax');
        // e.detail.request.status can be null or undefined
        // in case of CORS-related error. We should check
        // for that as well.
        var status = e.detail.request.status;
        if (status) {
          // Error 500 is probably a database issue.
          // Everything else will be 403.
          this._authFailure();
        } else {
          // Possibly a CORS error or backend not responding:
          this.warningMessage = 'Login server unuvailable, try again later.';
        }
        this.password = '';
      }

      _authFailure() {
        this.warningMessage = 'Invalid username or password.';
      }

    }
    window.customElements.define(LoginView.is, LoginView);
  </script>

</dom-module>
